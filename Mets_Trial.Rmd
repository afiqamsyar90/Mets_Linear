---
title: "Mets"
author: "Dr Afiq"
date: "2023-10-22"
output:
  pdf_document: default
  html_document: default
---

This is the data that our research team collected among the Malaysian general population. It is part of a larger dataset.We would like to understand the problem of Metabolic Syndrome among Malaysians.There were more than 4000 participants.We use readxl::read_xlsx() to read MS Excel datasets. And then use dplyr::glimpse() to briefly view the data.

## Create Environment

```{r}
library(tidyverse)
library(here)
library(haven)
library(readxl)
library(kableExtra)
library(broom)
library(cdata)
library(corrplot)
library(survival)
```
## Read data on Metabolic Sydrome

```{r}
met <- read_xlsx(here('metab_syndrome.xlsx')) %>% 
  janitor::clean_names()
glimpse(met)
```
```{r}
summary(met)
```
## convert the character variables (wrongly classed) to the correct numeric class variables

```{r}
met <- met %>% 
  mutate_at(vars(-id), ~as.numeric(.))
```

```{r}
summary(met)
```
## Check distribution of interested data

```{r}
met %>% 
  ggplot(aes(x = hba1c)) + 
  geom_histogram() 
```

## Data wrangling

```{r}
met <- met %>% 
  filter(hba1c > 2.5, hba1c < 25.0, 
         ldl > 0.5, hdl > 0.2,  
         totchol > 2.0, totchol < 15.0,
         fbs > 2, fbs < 20,
         pulse < 140) %>% 
  mutate(bmi = weight/(height^2), 
         overweight = if_else(bmi >=25.0,'overwt','not_overwt'),
         overweight = factor(overweight),
         dmdx = factor(dmdx, labels = c('NoDM', 'HaveDM')))
```

```{r}
summary(met)
```
## View interested data

```{r}
met %>% 
  ggplot(aes(x = hba1c)) + 
  geom_histogram() +
  facet_wrap(~ dmdx)
```

## Correlational analysis to give us idea for possible multicollinearity issues

```{r}
met_num <- met %>% 
  select_if(is.numeric)
```

## Correlogram to represent the correlation matrix

```{r}
cor.met <- cor(met_num, use="complete.obs", method="pearson")
head(round(cor.met,2))
```
## Correlogram

```{r}
corrplot(cor.met, method="circle")
```

## This is the model where the expected values of HBA1C is model as a function of FBS (fasting blood sugar).

```{r}
met_hba1c <- lm(hba1c ~ fbs, data = met)
summary(met_hba1c)
```
## Run another linear regression model with these covariates

```{r}
met_hba1c_mv <- lm(hba1c ~ fbs + age + msbpr + mdbpr, data = met)
summary(met_hba1c_mv)
```
## add Diabetic status into model

```{r}
met_hba1c_mv2 <- lm(hba1c ~ fbs + age + msbpr + mdbpr + bmi + hdl + ldl + dmdx, 
                    data = met)
summary(met_hba1c_mv2)
```
## We will add an interaction term (DMDX with AGE) in the covariates

```{r}
met_hba1c_ia <- lm(hba1c ~ fbs + age + msbpr + mdbpr + bmi + hdl + ldl + dmdx +
                     dmdx*age, data = met)
summary(met_hba1c_ia)
```
## broom package for better output

```{r}
tidy(met_hba1c_mv2, conf.int = TRUE)
```
## get predicted value

```{r}
pred_met <- augment(met_hba1c_mv2)
head(pred_met)
```

## check LINE assumption

```{r}
pred_met %>% 
  ggplot(aes(x = .resid)) +
  geom_histogram()
```

## check LINE assumption

```{r}
pred_met %>% 
  ggplot(aes(x = .fitted, y = .std.resid)) +
  geom_point()
```

## check LINE assumption

```{r}
pred_met %>% 
  filter(between(.std.resid, -3, 3)) %>% 
  ggplot(aes(x = .fitted, y = .std.resid)) +
  geom_point() 
```

